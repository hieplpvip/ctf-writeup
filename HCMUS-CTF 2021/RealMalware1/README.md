## RealMalware1

#### Solved by hieplpvip

```
A new ransomware is spreading wide, and xikhud is one of those victims. All of is data got encrypted. He sent a folder of encrypted data, and of course a sample of the malware to HCMUSML (HCMUS' Malware Laboratory) in the hope of getting back his data. Our researchers found that the malware sample was heavily obfuscated, but they had successfully decompiled, and translated it back to the C source code form. Unfortunately, they don't know how to decrypt the data. Can you help them ?

https://drive.google.com/drive/folders/1sCYquM-UZyLdr4qtB9mkxmAjkXSeKypB?usp=sharing

author: xikhud
```

From the source code, we know that:

- Files with extensions `exe`, `png`, or `pdf` are encrypted by `encrypt1`
- Other files are encrypted by `encrypt2`
- `encrypt2` xor the files with the key `0xDEADC0DE`. To decrypt, just xor again.
- `encrypt1` is XTEA, but the key is generated randomly at runtime. We can find XTEA decryption implementation online.

We decrypt `flag.txt.enc` and get the hint:

```
Flag is not here.
But, keep going.

Since you're here, I will give you a gift: the first 3 least significant bits of key is 110.
What you gonna do ?

Good luck.
```

`encrypt1` uses 32-bit key, and we already know 3, so we just need to brute force 29 bits. 2^29 is about 5e8, so it should run pretty fast. To save time, we only decrypt the first 4 bits of each file and check against known file signature:

- PNG: 0x89504E47
- EXE: 0x4d5a9000
- PDF: 0x25504446

I was able to find the key for `HelloWorld.exe.enc`, `RSA.pdf.enc`, and `coronaviruspdfhac4.pdf.enc`. They were all encrypted with key 0x806E17FE (which makes sense because they were probably encrypted at the same time). However, that key didn't work for `flag.png.enc`, and I couldn't find any other hints in the decrypted files, so I decided to brute force all 32 bits.

To my surprise, the key for `flag.png.enc` was 0. It turned out that there was some mistakes from the author.

![](flag.png)

**Flag:** `HCMUS-CTF{xxdd112233445566}`
